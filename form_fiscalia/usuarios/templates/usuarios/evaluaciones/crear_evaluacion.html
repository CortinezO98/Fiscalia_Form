{% extends "usuarios/base/base.html" %}
{% load static %}
{% block title %}Crear Evaluación{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <form method="post">
                {% csrf_token %}
                
                <!-- Tarjeta de Datos Básicos -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="h5 mb-0"><i class="bi bi-person-badge me-2"></i>Datos del Ciudadano</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="numero_identificacion" class="form-label">
                                    <i class="bi bi-123 me-1"></i>Número de Identificación
                                </label>
                                <input type="text" name="numero_identificacion" id="numero_identificacion" class="form-control" maxlength="20" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="tipo_identificacion" class="form-label">
                                    <i class="bi bi-card-checklist me-1"></i>Tipo de Identificación
                                </label>
                                <select name="tipo_identificacion" id="tipo_identificacion" class="form-select" required>
                                    <option value="" selected disabled>Seleccionar...</option>
                                    {% for tipo in tiposIdentificacion %}
                                        <option value="{{tipo.id}}">{{tipo.nombre}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">
                                    <i class="bi bi-person-circle me-1"></i>Nombre Completo
                                </label>
                                <input type="text" name="nombre" id="nombre" class="form-control" maxlength="255" required>
                            </div>

                            <div class="col-md-6">
                                <label for="conversacion_id" class="form-label">
                                    <i class="bi bi-chat-dots me-1"></i>ID Conversación
                                </label>
                                <input type="text" name="conversacion_id" id="conversacion_id" class="form-control" maxlength="250" required>
                                <div class="invalid-feedback">Ingrese un ID de conversación válido (mín. 5 caracteres)</div>
                            </div>

                            <!-- Correo -->
                            <div class="col-md-6">
                                <label for="correo" class="form-label">
                                    <i class="bi bi-envelope me-1"></i>Correo electrónico
                                </label>
                                <input type="email" name="correo" id="correo" class="form-control" maxlength="254">
                            </div>

                            <!-- Teléfono -->
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">
                                    <i class="bi bi-telephone me-1"></i>Teléfono
                                </label>
                                <input type="text" name="telefono" id="telefono" class="form-control" maxlength="20">
                            </div>

                            <!-- Dirección -->
                            <div class="col-md-6">
                                <label for="direccion_residencia" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Dirección de residencia
                                </label>
                                <input type="text" name="direccion_residencia" id="direccion_residencia" class="form-control" maxlength="255">
                            </div>

                            <!-- País -->
                            <div class="col-md-6">
                                <label for="pais" class="form-label">
                                    <i class="bi bi-globe me-1"></i>País
                                </label>
                                <select name="pais" id="pais" class="form-select">
                                    <option value="" disabled selected>Seleccionar país...</option>
                                    {% for p in paises %}
                                        <option value="{{ p.id }}">{{ p.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Ciudad -->
                            <div class="col-md-6">
                                <label for="ciudad" class="form-label">
                                    <i class="bi bi-building me-1"></i>Ciudad
                                </label>
                                <input type="text" name="ciudad" id="ciudad" class="form-control" maxlength="100">
                            </div>

                            <input type="text" name="cuidadano_id" id="cuidadano_id" value="" hidden>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta de Tipificación - NUEVA JERARQUÍA -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="h5 mb-0"><i class="bi bi-diagram-3 me-2"></i>Proceso de Tipificación</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Tipo de Canal -->
                            <div class="col-md-6">
                                <label for="tipo_canal" class="form-label">
                                    <i class="bi bi-broadcast me-1"></i>Tipo de Canal
                                </label>
                                <select name="tipo_canal" id="tipo_canal" class="form-select" required>
                                    <option value="" selected disabled>Seleccione un tipo de canal...</option>
                                    {% for tipo in tipos_canal %}
                                        <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Segmento -->
                            <div class="col-md-6">
                                <label for="segmento" class="form-label">
                                    <i class="bi bi-diagram-2 me-1"></i>Segmento
                                </label>
                                <select name="segmento" id="segmento" class="form-select" required>
                                    <option value="" selected disabled>Seleccione un segmento...</option>
                                </select>
                            </div>

                            <!-- Segmento II (condicional) -->
                            <div class="col-md-6" id="segmento_ii_container" style="display: none;">
                                <label for="segmento_ii" class="form-label">
                                    <i class="bi bi-diagram-3 me-1"></i>Segmento II
                                </label>
                                <select name="segmento_ii" id="segmento_ii" class="form-select">
                                    <option value="" selected disabled>Seleccione un segmento II...</option>
                                </select>
                            </div>

                            <!-- Tipificación -->
                            <div class="col-md-6">
                                <label for="tipificacion" class="form-label">
                                    <i class="bi bi-tag me-1"></i>Tipificación
                                </label>
                                <select name="tipificacion" id="tipificacion" class="form-select" required>
                                    <option value="" selected disabled>Seleccione una tipificación...</option>
                                </select>
                            </div>

                            <!-- Categoría -->
                            <div class="col-md-6">
                                <label for="categoria" class="form-label">
                                    <i class="bi bi-menu-button me-1"></i>Categoría
                                    <span class="text-muted small" id="categoria_optional_label" style="display: none;">(Opcional)</span>
                                </label>
                                <select name="categoria" id="categoria" class="form-select" required>
                                    <option value="" selected disabled>Selecciona una categoría</option>
                                </select>
                            </div>

                            <!-- Subcategoría (condicional) -->
                            <div class="col-md-6" id="subcategoria_container" style="display: none;">
                                <label for="subcategoria" class="form-label">
                                    <i class="bi bi-menu-button-wide me-1"></i>Sub Categoría
                                </label>
                                <select name="subcategoria" id="subcategoria" class="form-select">
                                    <option value="" selected disabled>Selecciona una sub categoría</option>
                                </select>
                            </div>

                            <!-- Campo especial para "OTROS DELITOS" -->
                            <div class="col-12" id="otros_delitos_container" style="display: none;">
                                <label for="cual_otro_delito" class="form-label">
                                    <i class="bi bi-question-circle me-1"></i>¿Cuál otro delito?
                                </label>
                                <input type="text" name="cual_otro_delito" id="cual_otro_delito" class="form-control" maxlength="500" placeholder="Especifique el delito...">
                                <small class="text-muted">Este campo solo se muestra cuando se selecciona 'OTROS DELITOS'</small>
                            </div>

                            <!-- Observaciones -->
                            <div class="col-12">
                                <label for="observacion" class="form-label">
                                    <i class="bi bi-chat-text me-1"></i>Observaciones
                                </label>
                                <textarea name="observacion" id="observacion" class="form-control" rows="3" placeholder="Observaciones generales" required></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVA TARJETA: INFORMACIÓN ADICIONAL -->
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h3 class="h5 mb-0"><i class="bi bi-question-circle me-2"></i>Información Adicional</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            
                            <!-- PREGUNTA 1: Se comunica de una URI -->
                            <div class="col-12">
                                <div class="card border-primary border-opacity-25">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-geo-alt-fill me-2"></i>¿Se comunica de una URI?
                                        </h6>
                                        
                                        <div class="row g-3">
                                            <!-- Opciones SI/NO -->
                                            <div class="col-md-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="se_comunica_uri" id="uri_si" value="1">
                                                    <label class="form-check-label" for="uri_si">
                                                        <i class="bi bi-check-circle text-success me-1"></i>SÍ
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="se_comunica_uri" id="uri_no" value="0">
                                                    <label class="form-check-label" for="uri_no">
                                                        <i class="bi bi-x-circle text-danger me-1"></i>NO
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Campo Ciudad/Municipio (condicional) -->
                                            <div class="col-md-6" id="ciudad_municipio_container" style="display: none;">
                                                <label for="ciudad_municipio_uri" class="form-label">
                                                    <i class="bi bi-building me-1"></i>Ciudad/Municipio
                                                </label>
                                                <input type="text" name="ciudad_municipio_uri" id="ciudad_municipio_uri" 
                                                       class="form-control" maxlength="200" 
                                                       placeholder="Indique ciudad/municipio">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PREGUNTA 2: Consulta jurídica -->
                            <div class="col-12">
                                <div class="card border-primary border-opacity-25">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">
                                            <i class="bi bi-briefcase-fill me-2"></i>¿Consulta jurídica?
                                        </h6>
                                        
                                        <div class="row g-3">
                                            <!-- Opciones SI/NO -->
                                            <div class="col-md-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="consulta_juridica" id="juridica_si" value="1">
                                                    <label class="form-check-label" for="juridica_si">
                                                        <i class="bi bi-check-circle text-success me-1"></i>SÍ
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="consulta_juridica" id="juridica_no" value="0">
                                                    <label class="form-check-label" for="juridica_no">
                                                        <i class="bi bi-x-circle text-danger me-1"></i>NO
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Campo Abogado (condicional) -->
                                            <div class="col-md-6" id="abogado_container" style="display: none;">
                                                <label for="abogado" class="form-label">
                                                    <i class="bi bi-person-badge me-1"></i>Abogado
                                                </label>
                                                <select name="abogado" id="abogado" class="form-select">
                                                    <option value="" selected disabled>Seleccione abogado</option>
                                                    {% for abogado in abogados %}
                                                        <option value="{{ abogado.id }}">{{ abogado.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="{% url 'index' %}" class="btn btn-outline-secondary mx-2">
                        Cancelar
                    </a>
                    <button type="reset" class="btn btn-secondary mx-2">
                        <i class="bi bi-arrow-clockwise me-2"></i>Limpiar Campos
                    </button>
                    <button type="submit" class="btn btn-primary mx-2">
                        <i class="bi bi-save me-2"></i>Guardar Evaluación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // ==================== FUNCIONES AUXILIARES ====================
        
        function mostrarMensaje(mensaje) {
            Swal.fire({
                text: mensaje,
                icon: "warning"
            });
        }

        function limpiarSelect(selector, mensaje) {
            $(selector).empty().append(`<option value="" disabled selected>${mensaje}</option>`);
        }

        function mostrarContainer(containerId, show = true) {
            const container = $(`#${containerId}`);
            
            if (show) {
                container.show();
                container.removeClass('d-none');
            } else {
                container.hide();
                container.addClass('d-none');
                container.find('select, input').prop('required', false);
            }
        }

        // ==================== NUEVAS FUNCIONES PARA PREGUNTAS ADICIONALES ====================
        
        // Manejo de la pregunta "Se comunica de una URI"
        $('input[name="se_comunica_uri"]').on('change', function() {
            const valor = $(this).val();
            const ciudadContainer = $('#ciudad_municipio_container');
            const ciudadInput = $('#ciudad_municipio_uri');
            
            if (valor === '1') { // SÍ
                ciudadContainer.show().removeClass('d-none');
                ciudadInput.prop('required', true);
                // Agregar animación suave
                ciudadContainer.hide().fadeIn(300);
            } else { // NO
                ciudadContainer.fadeOut(300, function() {
                    ciudadInput.prop('required', false).val('');
                });
            }
        });

        // Manejo de la pregunta "Consulta jurídica"
        $('input[name="consulta_juridica"]').on('change', function() {
            const valor = $(this).val();
            const abogadoContainer = $('#abogado_container');
            const abogadoSelect = $('#abogado');
            
            if (valor === '1') { // SÍ
                abogadoContainer.show().removeClass('d-none');
                abogadoSelect.prop('required', true);
                // Agregar animación suave
                abogadoContainer.hide().fadeIn(300);
            } else { // NO
                abogadoContainer.fadeOut(300, function() {
                    abogadoSelect.prop('required', false).val('');
                });
            }
        });

        // ==================== CARGA INICIAL ====================
        
        // Cargar tipificaciones (son universales)
        $.ajax({
            url: '/api/tipificaciones/',
            method: 'GET',
            success: function(response) {
                limpiarSelect('#tipificacion', 'Seleccione una tipificación...');
                response.forEach(function(tip) {
                    $('#tipificacion').append(`<option value="${tip.id}">${tip.nombre}</option>`);
                });
            },
            error: function() {
                mostrarMensaje('Error al cargar tipificaciones');
            }
        });

        // ==================== BÚSQUEDA DE CIUDADANO ====================
        
        $('#numero_identificacion').on('change', function() {
            const numero = $(this).val().trim();
            if (!numero) {
                $('#cuidadano_id').val('');
                return;
            }
            
            $.ajax({
                url: '/api/ciudadano/',
                method: 'GET',
                data: { numero_identificacion: numero },
                success: function(response) {
                    if (response && response.id) {
                        $('#tipo_identificacion').val(response.tipo_identificacion_id);
                        $('#nombre').val(response.nombre);
                        $('#correo').val(response.correo || '');
                        $('#telefono').val(response.telefono || '');
                        $('#direccion_residencia').val(response.direccion_residencia || '');
                        $('#pais').val(response.pais_id || '');
                        $('#ciudad').val(response.ciudad || '');
                        $('#cuidadano_id').val(response.id);
                    } else {
                        $('#cuidadano_id').val('');
                    }
                },
                error: function() {
                    $('#cuidadano_id').val('');
                }
            });
        });

        // ==================== NUEVA JERARQUÍA DE TIPIFICACIÓN ====================
        
        // 1. Tipo Canal → Segmentos
        $('#tipo_canal').on('change', function() {
            const tipoCanal = $(this).val();
            
            if (!tipoCanal) return;

            // Limpiar selects dependientes
            limpiarSelect('#segmento', 'Cargando segmentos...');
            limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
            limpiarSelect('#categoria', 'Selecciona una categoría');
            limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
            mostrarContainer('segmento_ii_container', false);
            mostrarContainer('subcategoria_container', false);

            $.ajax({
                url: '/api/segmentos/',
                method: 'GET',
                data: { tipo_canal_id: tipoCanal },
                success: function(response) {
                    limpiarSelect('#segmento', 'Seleccione un segmento...');
                    if (response.length > 0) {
                        response.forEach(function(seg) {
                            $('#segmento').append(`<option value="${seg.id}" data-tiene-segmento-ii="${seg.tiene_segmento_ii}">${seg.nombre}</option>`);
                        });
                    } else {
                        mostrarMensaje('El tipo de canal seleccionado no tiene segmentos disponibles.');
                    }
                },
                error: function() {
                    mostrarMensaje('Error al cargar segmentos.');
                }
            });
        });

        // 2. Segmento → Segmento II (condicional)
        $('#segmento').on('change', function() {
            const segmentoId = $(this).val();
            const selectedOption = $(this).find('option:selected');
            const tieneSegmentoII = selectedOption.data('tiene-segmento-ii') === true || selectedOption.data('tiene-segmento-ii') === 'true';

            // Limpiar selects dependientes
            limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
            limpiarSelect('#categoria', 'Selecciona una categoría');
            limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
            mostrarContainer('subcategoria_container', false);

            if (tieneSegmentoII) {
                mostrarContainer('segmento_ii_container', true);
                $('#segmento_ii').prop('required', true);

                $.ajax({
                    url: '/api/segmentos-ii/',
                    method: 'GET',
                    data: { segmento_id: segmentoId },
                    success: function(response) {
                        limpiarSelect('#segmento_ii', 'Seleccione un segmento II...');
                        if (response.length > 0) {
                            response.forEach(function(seg2) {
                                $('#segmento_ii').append(`<option value="${seg2.id}">${seg2.nombre}</option>`);
                            });
                        } else {
                            mostrarMensaje('El segmento seleccionado no tiene segmentos II disponibles.');
                        }
                    },
                    error: function() {
                        mostrarMensaje('Error al cargar segmentos II.');
                    }
                });
            } else {
                mostrarContainer('segmento_ii_container', false);
                $('#segmento_ii').prop('required', false);
            }
        });

        // 3. Tipificación → Categorías
        $('#tipificacion').on('change', function() {
            const tipificacionId = $(this).val();

            if (!tipificacionId) return;

            // Limpiar selects dependientes
            limpiarSelect('#categoria', 'Cargando categorías...');
            limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
            mostrarContainer('subcategoria_container', false);
            mostrarContainer('otros_delitos_container', false);
            $('#cual_otro_delito').prop('required', false).val('');

            $.ajax({
                url: '/api/categorias/',
                method: 'GET',
                data: { tipificacion_id: tipificacionId },
                success: function(response) {
                    if (response.length > 0) {
                        // Tiene categorías - Funcionamiento normal
                        limpiarSelect('#categoria', 'Selecciona una categoría');
                        response.forEach(function(cat) {
                            $('#categoria').append(`<option value="${cat.id}">${cat.nombre}</option>`);
                        });
                        $('#categoria').prop('required', true);
                        $('#categoria_optional_label').hide();
                        
                        // Mostrar mensaje informativo
                        Swal.fire({
                            title: 'Categorías cargadas',
                            text: `Se encontraron ${response.length} categoría(s) disponibles.`,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end'
                        });
                    } else {
                        // No tiene categorías - Tipificación directa
                        limpiarSelect('#categoria', 'Sin categorías - Tipificación directa');
                        $('#categoria').prop('required', false);
                        $('#categoria_optional_label').show();
                        
                        // Agregar opción especial para tipificaciones sin categorías
                        $('#categoria').append(`<option value="0" selected>Sin categoría específica</option>`);
                        
                        // Mostrar mensaje informativo
                        Swal.fire({
                            title: 'Tipificación directa',
                            text: 'Esta tipificación no requiere selección de categoría.',
                            icon: 'info',
                            timer: 3000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end'
                        });
                    }
                },
                error: function() {
                    mostrarMensaje('Error al cargar categorías.');
                }
            });
        });

        // 4. Categoría → Subcategorías (condicional)
        $('#categoria').on('change', function() {
            const categoriaId = $(this).val();
            const categoriaTexto = $(this).find('option:selected').text().toUpperCase();

            if (!categoriaId) return;

            // Verificar si es "OTROS DELITOS" en CATEGORÍA
            const esOtrosDelitos = categoriaTexto.includes('OTROS DELITOS') || 
                                 categoriaTexto.includes('OTRO DELITO') ||
                                 categoriaTexto.includes('OTROS DELITO') ||
                                 categoriaTexto.includes('OTRO DELITOS') ||
                                 categoriaTexto.includes('OTRO') ||
                                 categoriaTexto.includes('OTROS');

            if (esOtrosDelitos) {
                mostrarContainer('otros_delitos_container', true);
                $('#cual_otro_delito').prop('required', true);
            } else {
                // Solo ocultar si no hay subcategorías que lo puedan activar
                mostrarContainer('otros_delitos_container', false);
                $('#cual_otro_delito').prop('required', false).val('');
            }

            // Limpiar subcategorías
            limpiarSelect('#subcategoria', 'Buscando subcategorías...');
            mostrarContainer('subcategoria_container', false);
            $('#subcategoria').prop('required', false);

            $.ajax({
                url: '/api/subcategorias/',
                method: 'GET',
                data: { categoria_padre_id: categoriaId },
                success: function(response) {
                    if (response.length > 0) {
                        limpiarSelect('#subcategoria', 'Selecciona una sub categoría');
                        response.forEach(function(sub) {
                            $('#subcategoria').append(`<option value="${sub.id}">${sub.nombre}</option>`);
                        });

                        // Mostrar el contenedor y hacer requerido
                        mostrarContainer('subcategoria_container', true);
                        $('#subcategoria').prop('required', true);
                    }
                },
                error: function() {
                    console.log('No hay subcategorías disponibles o error en la consulta');
                }
            });
        });

        // 5. Subcategoría → Verificar "OTROS DELITOS"
        $('#subcategoria').on('change', function() {
            const subcategoriaTexto = $(this).find('option:selected').text().toUpperCase();

            // Verificar si es "OTROS DELITOS" en SUBCATEGORÍA
            const esOtrosDelitos = subcategoriaTexto.includes('OTROS DELITOS') || 
                                 subcategoriaTexto.includes('OTRO DELITO') ||
                                 subcategoriaTexto.includes('OTROS DELITO') ||
                                 subcategoriaTexto.includes('OTRO DELITOS') ||
                                 subcategoriaTexto.includes('OTRO') ||
                                 subcategoriaTexto.includes('OTROS');

            if (esOtrosDelitos) {
                mostrarContainer('otros_delitos_container', true);
                $('#cual_otro_delito').prop('required', true);
            } else {
                mostrarContainer('otros_delitos_container', false);
                $('#cual_otro_delito').prop('required', false).val('');
            }
        });

        // ==================== VALIDACIÓN DEL FORMULARIO ====================
        
        $('form').on('submit', function(e) {
            // Verificar que todos los campos requeridos estén llenos
            const tipoCanal = $('#tipo_canal').val();
            const segmento = $('#segmento').val();
            const tipificacion = $('#tipificacion').val();
            const categoria = $('#categoria').val();
            const categoriaEsRequerida = $('#categoria').prop('required');
            
            if (!tipoCanal || !segmento || !tipificacion) {
                e.preventDefault();
                mostrarMensaje('Por favor complete los campos de tipificación requeridos.');
                return false;
            }

            // Solo validar categoría si es requerida
            if (categoriaEsRequerida && !categoria) {
                e.preventDefault();
                mostrarMensaje('Por favor seleccione una categoría.');
                return false;
            }

            // Verificar Segmento II si es requerido
            const segmentoIIContainer = $('#segmento_ii_container');
            if (segmentoIIContainer.is(':visible') && $('#segmento_ii').prop('required')) {
                const segmentoII = $('#segmento_ii').val();
                if (!segmentoII) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione un Segmento II.');
                    return false;
                }
            }

            // Verificar Subcategoría si es requerida
            const subcategoriaContainer = $('#subcategoria_container');
            if (subcategoriaContainer.is(':visible') && $('#subcategoria').prop('required')) {
                const subcategoria = $('#subcategoria').val();
                if (!subcategoria) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione una subcategoría.');
                    return false;
                }
            }

            // Verificar campo "¿Cuál otro delito?" si es requerido
            const otrosDelitosContainer = $('#otros_delitos_container');
            if (otrosDelitosContainer.is(':visible') && $('#cual_otro_delito').prop('required')) {
                const cualOtroDelito = $('#cual_otro_delito').val().trim();
                if (!cualOtroDelito) {
                    e.preventDefault();
                    mostrarMensaje('Por favor especifique cuál es el otro delito.');
                    $('#cual_otro_delito').focus();
                    return false;
                }
            }

            // ==================== NUEVAS VALIDACIONES PARA PREGUNTAS ADICIONALES ====================
            
            // Verificar campo Ciudad/Municipio si "Se comunica de una URI" es SÍ
            const uriSeleccionada = $('input[name="se_comunica_uri"]:checked').val();
            if (uriSeleccionada === '1') {
                const ciudadMunicipio = $('#ciudad_municipio_uri').val().trim();
                if (!ciudadMunicipio) {
                    e.preventDefault();
                    mostrarMensaje('Por favor indique la ciudad/municipio de la URI.');
                    $('#ciudad_municipio_uri').focus();
                    return false;
                }
            }

            // Verificar campo Abogado si "Consulta jurídica" es SÍ
            const consultaJuridica = $('input[name="consulta_juridica"]:checked').val();
            if (consultaJuridica === '1') {
                const abogado = $('#abogado').val();
                if (!abogado) {
                    e.preventDefault();
                    mostrarMensaje('Por favor seleccione un abogado para la consulta jurídica.');
                    $('#abogado').focus();
                    return false;
                }
            }
        });

        // ==================== LIMPIAR FORMULARIO (RESET) ====================
        
        $('button[type="reset"]').on('click', function() {
            // Limpiar campos adicionales
            $('input[name="se_comunica_uri"]').prop('checked', false);
            $('input[name="consulta_juridica"]').prop('checked', false);
            $('#ciudad_municipio_container').hide();
            $('#abogado_container').hide();
            $('#ciudad_municipio_uri').prop('required', false).val('');
            $('#abogado').prop('required', false).val('');
            
            // Limpiar otros contenedores condicionales
            mostrarContainer('segmento_ii_container', false);
            mostrarContainer('subcategoria_container', false);
            mostrarContainer('otros_delitos_container', false);
        });
    });
</script>

{% endblock %}